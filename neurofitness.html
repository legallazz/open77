<!DOCTYPE html>
<html lang="ru">

<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>Цифровая Библиотека</title>
   <meta name="description" content="Читайте книги онлайн с настройкой цветов и темы для комфортного чтения." />
   <link rel="stylesheet" href="styles/main.css" />
   <link rel="stylesheet" href="styles/reader.css" />
   <link rel="stylesheet" href="styles/reading-settings.css" />
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

   <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
   <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
   <link rel="shortcut icon" href="/favicon/favicon.ico" />
   <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />

   <!-- Предотвращение мелькания темы -->
   <script>
      (function () {
         try {
            const saved = localStorage.getItem('reading-settings');
            if (saved) {
               const settings = JSON.parse(saved);
               const themes = {
                  dark: {
                     "--reader-background": "#111827",
                     "--reader-page": "#1e293b",
                     "--reader-text": "#f8fafc",
                     "--reader-border": "#111827"
                  },
                  "dark-blue": {
                     "--reader-background": "#171717",
                     "--reader-page": "#202124",
                     "--reader-text": "#f1f5f9",
                     "--reader-border": "#171717"
                  },
                  "dark-warm": {
                     "--reader-background": "#1c1917",
                     "--reader-page": "#292524",
                     "--reader-text": "#e7e5e4",
                     "--reader-border": "#1c1917"
                  },
                  light: {
                     "--reader-background": "#f8fafc",
                     "--reader-page": "#ffffff",
                     "--reader-text": "#1f2937",
                     "--reader-border": "#e5e7eb"
                  },
                  "light-warm": {
                     "--reader-background": "#7e7e8f",
                     "--reader-page": "#c6c6d5",
                     "--reader-text": "#202020",
                     "--reader-border": "#7e7e8f"
                  },
                  sepia: {
                     "--reader-background": "#f5e6d3",
                     "--reader-page": "#fdf6e3",
                     "--reader-text": "#644339",
                     "--reader-border": "#f5e6d3"
                  },
                  blue: {
                     "--reader-background": "#edf2f7",
                     "--reader-page": "#e2e8f0",
                     "--reader-text": "#2d3748",
                     "--reader-border": "#bdc4c8"
                  },
                  green: {
                     "--reader-background": "#e6ddd6",
                     "--reader-page": "#faf8f2",
                     "--reader-text": "#302d27",
                     "--reader-border": "#e6e7e0"
                  }
               };

               const theme = themes[settings.theme] || themes.dark;
               const brightness = settings.brightness || 1.0;
               const root = document.documentElement;

               // Функция для изменения яркости цвета
               function adjustColorBrightness(color, brightness) {
                  const hex = color.replace('#', '');
                  const r = parseInt(hex.substr(0, 2), 16);
                  const g = parseInt(hex.substr(2, 2), 16);
                  const b = parseInt(hex.substr(4, 2), 16);

                  const newR = Math.round(Math.min(255, r * brightness));
                  const newG = Math.round(Math.min(255, g * brightness));
                  const newB = Math.round(Math.min(255, b * brightness));

                  const toHex = (n) => n.toString(16).padStart(2, '0');
                  return '#' + toHex(newR) + toHex(newG) + toHex(newB);
               }

               // Применяем тему с яркостью
               Object.keys(theme).forEach(variable => {
                  const adjustedColor = adjustColorBrightness(theme[variable], brightness);
                  root.style.setProperty(variable, adjustedColor);
               });
            }
         } catch (e) {
            // Ignore errors, fallback to default theme
         }
      })();
   </script>
</head>

<body>
   <div class="theme-toggle-container">
      <button id="theme-toggle" class="theme-toggle" aria-label="Переключить тему">
         <i class="fas fa-sun sun-icon"></i>
         <i class="fas fa-moon moon-icon"></i>
      </button>
   </div>

   <!-- Navigation -->
   <nav class="book-nav">
      <div class="nav-content">
         <a href="index.html" class="back-btn" data-testid="button-back-home">
            <i class="fas fa-chevron-left"></i>
            Назад к библиотеке
         </a>
      </div>
   </nav>

   <!-- Book Header -->
   <header class="book-header">
      <div class="container">
         <div class="book-header-content">
            <div class="book-cover-large">
               <img id="book-poster" src="/img/poster.jpg" alt="Обложка книги" />
               <div class="age-restriction-badge">
                  <span>99+</span>
               </div>
            </div>
            <div class="book-details">
               <h1 class="book-title-large" id="book-title">Название книги</h1>
               <p class="book-author-large" id="book-author">Автор неизвестен</p>
               <p class="book-description-large" id="book-description">
                  Описание отсутствует
               </p>
               <div class="book-actions">
                  <button id="start-reading" class="btn-primary btn-large" data-testid="button-start-reading">
                     <i class="fas fa-book-open"></i>
                     Начать чтение
                  </button>
                  <button id="continue-reading" class="btn-primary" style="display: none"
                     data-testid="button-continue-reading">
                     <i class="fas fa-arrow-right"></i>
                     Продолжить чтение
                  </button>
                  <button id="continue-listening" class="btn-primary" style="display: none"
                     data-testid="button-continue-listening">
                     <i class="fas fa-play"></i>
                     Продолжить слушать
                  </button>

                  <!-- КНОПКА СКАЧИВАНИЯ КНИГИ -->
                  <a href="#" id="download-book" class="btn-secondary" data-testid="button-download-book">
                     <i class="fas fa-download"></i>
                     Скачать книгу
                  </a>
               </div>

               <div class="reading-progress">
                  <div class="progress-section" id="reading-progress-section">
                     <div class="progress-info">
                        <i class="fas fa-book-open"></i>
                        <span class="progress-label">Прогресс чтения</span>
                     </div>
                     <div class="progress-bar">
                        <div class="progress-fill" id="reading-progress-fill" style="width: 0%"></div>
                        <!-- Дублируем для совместимости со старым кодом -->
                        <div class="progress-fill" id="progress-fill" style="width: 0%; display: none;"></div>
                     </div>
                     <span class="progress-text" id="reading-progress-text">0%</span>
                     <!-- Дублируем для совместимости со старым кодом -->
                     <span class="progress-text" id="progress-text" style="display: none;">0%</span>
                  </div>

                  <div class="progress-section" id="audio-progress-section">
                     <div class="progress-info">
                        <i class="fas fa-headphones"></i>
                        <span class="progress-label">Прогресс аудиокниги</span>
                     </div>
                     <div class="progress-bar">
                        <div class="progress-fill" id="audio-main-progress-fill" style="width: 0%"></div>
                     </div>
                     <span class="progress-text" id="audio-main-progress-text">0%</span>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </header>

   <!-- Audio Section (will be hidden if no audio) -->
   <section class="audio-section" id="audio-section" style="display: none">
      <div class="container">
         <div class="audio-player" id="audio-player">
            <div class="audio-info">
               <h3 id="audio-title">Аудиокнига</h3>
               <p id="current-chapter-info">Выберите главу для прослушивания</p>
            </div>
            <div class="audio-controls">
               <div class="audio-controls-main">
                  <button id="prev-chapter" class="audio-btn" title="Предыдущая глава">
                     <i class="fas fa-step-backward"></i>
                  </button>
                  <button id="play-pause-btn" class="audio-btn" data-testid="button-audio-play">
                     <i class="fas fa-play play-icon"></i>
                     <i class="fas fa-pause pause-icon" style="display: none"></i>
                  </button>
                  <button id="next-chapter" class="audio-btn" title="Следующая глава">
                     <i class="fas fa-step-forward"></i>
                  </button>
                  <div class="audio-progress">
                     <span id="current-time">0:00</span>
                     <input type="range" id="audio-progress-bar" min="0" max="100" value="0" class="progress-slider" />
                     <span id="total-time">0:00</span>
                  </div>
               </div>
               <div class="volume-controls">
                  <button id="mute-btn" class="audio-btn">
                     <i class="fas fa-volume-up volume-icon"></i>
                     <i class="fas fa-volume-mute mute-icon" style="display: none"></i>
                  </button>
                  <input type="range" id="volume-control" min="0" max="100" value="100" class="volume-slider" />
               </div>
            </div>
         </div>

         <!-- Список глав аудиокниги -->
         <div class="chapters-list" id="chapters-list">
            <h4>Главы аудиокниги</h4>
            <div class="chapters-grid" id="chapters-grid">
               <!-- Главы будут добавлены автоматически через JavaScript -->
            </div>
         </div>
      </div>
   </section>

   <!-- Text Version Section (shown when no audio) -->
   <section class="text-version-section" id="text-version-section" style="display: none">
      <div class="container">
         <div class="text-version-content">
            <div class="text-version-icon">
               <i class="fas fa-book-reader"></i>
            </div>
            <div class="text-version-info">
               <h3>Только текстовая версия</h3>
               <p>
                  Для этой книги доступна только текстовая версия. Аудиозаписи
                  отсутствуют.
               </p>
               <p>
                  Вы можете насладиться чтением книги в удобном формате с настройкой
                  цветов и шрифтов.
               </p>
            </div>
            <div class="text-version-actions">
               <button id="start-text-reading" class="btn-primary">
                  <i class="fas fa-book-open"></i>
                  Начать чтение
               </button>
            </div>
         </div>
      </div>
   </section>

   <!-- Full Screen Reading Modal -->
   <div class="reading-modal" id="reading-modal" style="display: none">
      <!-- Fixed Top Menu -->
      <div class="reading-menu">
         <div class="container-menu">
            <div class="reading-menu-left">
               <button id="exit-reading" class="exit-btn back-btn" data-testid="button-exit-reading">
                  <i class="fas fa-chevron-left"></i>
                  Выйти из режима чтения
               </button>
            </div>
            <div class="reading-menu-center">
               <div class="reading-progress">
                  <div class="progress-bar">
                     <div class="progress-fill" id="reading-modal-progress-fill" style="width: 0%"></div>
                  </div>
                  <span class="progress-text" id="reading-modal-progress-text">0%</span>
               </div>
            </div>
            <!-- В reading-menu-right -->
            <div class="reading-menu-right">
               <!-- Кнопка полноэкранного режима -->
               <button id="fullscreen-toggle" class="menu-btn" title="Полноэкранный режим">
                  <i class="fas fa-expand fullscreen-expand"></i>
                  <i class="fas fa-compress fullscreen-compress" style="display: none;"></i>
               </button>
               <!-- Кнопка скрытия/раскрытия меню -->
               <button id="toggle-menu-visibility" class="menu-btn" title="Скрыть меню">
                  <i class="fas fa-eye-slash"></i>
               </button>
               <!-- кнопка -->
               <button id="reading-color-settings" class="menu-btn settings-btn">
                  <i class="fas fa-cog"></i>
                  Настроить
               </button>
            </div>
         </div>
      </div>

      <!-- Reading Content -->
      <div class="reading-content">
         <article class="book-content" id="book-content" style="
            background: var(--reader-page, var(--background-primary));
            color: var(--reader-text, var(--text-primary));
          ">
            <!-- Содержимое книги будет загружено здесь -->
         </article>
      </div>

   </div>

   <!-- Боковая панель настроек -->
   <div class="settings-sidebar" id="settings-sidebar">
      <div class="settings-header">
         <h3>Настройки чтения</h3>
         <button class="settings-close" id="settings-close">
            <i class="fas fa-times"></i>
         </button>
      </div>

      <div class="settings-content">
         <!-- Размер шрифта -->
         <div class="settings-group">
            <label>Размер текста</label>
            <div class="font-controls">
               <div class="font-size-control">
                  <button id="font-size-decrease" class="font-size-btn">
                     <i class="fas fa-minus"></i>
                  </button>
                  <span id="font-size-display">18px</span>
                  <button id="font-size-increase" class="font-size-btn">
                     <i class="fas fa-plus"></i>
                  </button>
               </div>
            </div>
            <div class="font-preview" style="display: none">
               <p class="font-preview-text">
                  Пример текста для предварительного просмотра настроек шрифта и
                  выравнивания.
               </p>
            </div>
         </div>

         <!-- Яркость -->
         <div class="settings-group">
            <label>Яркость</label>
            <div class="font-controls">
               <div class="brightness-control">
                  <i class="fas fa-sun brightness-icon"></i>
                  <input type="range" id="brightness-slider" min="0.3" max="1.0" step="0.1" value="1.0"
                     class="brightness-slider">
                  <span id="brightness-display">100%</span>
               </div>
            </div>
         </div>

         <!-- Шрифт -->
         <div class="settings-group">
            <label>Шрифт</label>
            <div class="font-controls2">
               <select id="font-family-select" class="settings-select">
                  <option value="Inter">Inter</option>
                  <option value="Roboto">Roboto</option>
                  <option value="Arial">Arial</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Verdana">Verdana</option>
                  <option value="Kazimir">Kazimir</option>
               </select>
            </div>
         </div>

         <!-- Выравнивание -->
         <div class="settings-group">
            <label>📄 Выравнивание текста</label>
            <div class="font-controls2">
               <div class="text-align-buttons">
                  <button id="text-align-left" class="setting-btn">
                     <i class="fas fa-align-left"></i>
                     <span>По левому краю</span>
                  </button>
                  <button id="text-align-justify" class="setting-btn active">
                     <i class="fas fa-align-justify"></i>
                     <span>По ширине</span>
                  </button>
               </div>
            </div>
         </div>

         <!-- Темы -->
         <div class="settings-group">
            <label style="padding-bottom: 10px">🎨 Темы оформления</label>
            <div class="font-controls2">
               <div class="themes-grid">


                  <div class="theme-preset active" data-theme="dark">
                     <div class="theme-dot" style="background: linear-gradient(135deg, #111827, #1f2937)"></div>
                     <span class="theme-name">Ночное небо</span>
                  </div>


                  <div class="theme-preset" data-theme="dark-blue">
                     <div class="theme-dot" style="background: linear-gradient(135deg, #171717, #202124)"></div>
                     <span class="theme-name">Асфальт</span>
                  </div>


                  <div class="theme-preset" data-theme="dark-warm">
                     <div class="theme-dot" style="background: linear-gradient(135deg, #1c1917, #292524)"></div>
                     <span class="theme-name">Тёмный кофе</span>
                  </div>


                  <div class="theme-preset" data-theme="light-warm">
                     <div class="theme-dot" style="background: linear-gradient(135deg, #7e7e8f, #ddd)"></div>
                     <span class="theme-name">Туман</span>
                  </div>

                  <div class="theme-preset" data-theme="light">
                     <div class="theme-dot" style="background: linear-gradient(135deg, #f8fafc, #ffffff)"></div>
                     <span class="theme-name">Классический</span>
                  </div>


                  <div class="theme-preset" data-theme="sepia">
                     <div class="theme-dot" style="background: linear-gradient(135deg, #f5e6d3, #fdf6e3)"></div>
                     <span class="theme-name">Винтаж</span>
                  </div>


                  <div class="theme-preset" data-theme="blue">
                     <div class="theme-dot" style="background: linear-gradient(135deg, #e0f2fe, #f0f9ff)"></div>
                     <span class="theme-name">Современный UI</span>
                  </div>


                  <div class="theme-preset" data-theme="green">
                     <div class="theme-dot" style="background: #f8f9f4"></div>
                     <span class="theme-name">Старая книга</span>
                  </div>


               </div>
            </div>
         </div>
      </div>
   </div>


   <!-- Scripts -->
   <script src="js/book-config.js"></script>
   <script src="js/theme.js"></script>
   <script src="js/audio-player.js"></script>
   <script src="js/book-loader.js"></script>
   <script src="js/reader.js"></script>
   <script src="js/color-customizer.js"></script>
   <script src="js/reading-settings.js"></script>
   <script src="js/progress-manager.js"></script>

   <script>
      document.addEventListener("DOMContentLoaded", function () {
         // Динамически обновляем данные из конфигурации книги
         const bookConfig = window.bookConfig?.getCurrentBook();
         if (bookConfig) {
            // Обновляем возрастной рейтинг
            const ageRating = bookConfig.ageRating || "16+";
            const ageBadge = document.querySelector('.age-restriction-badge span');
            if (ageBadge) {
               ageBadge.textContent = ageRating;
            }

            // Обновляем текст в метаданных
            const ageMetadata = document.querySelector('.metadata-item:nth-child(2) span');
            if (ageMetadata) {
               ageMetadata.textContent = `Возрастное ограничение: ${ageRating}`;
            }

            // Обновляем время чтения
            const readingTime = bookConfig.readingTime || "~8 часов";
            const timeMetadata = document.querySelector('.metadata-item:nth-child(1) span');
            if (timeMetadata) {
               timeMetadata.textContent = `${readingTime} чтения`;
            }
         }
      });



      // Инициализация после загрузки DOM
      document.addEventListener("DOMContentLoaded", function () {

         // Загружаем и отображаем прогресс после инициализации
         setTimeout(() => {
            const progress = window.bookReader?.loadReadingProgress();
            if (progress) {
               window.bookReader.updateProgress(progress.progress || 0);
            }
         }, 500);



         // Инициализация настроек чтения
         window.readingSettings = new ReadingSettings();

         // Инициализация книги
         const bookConfig = window.bookConfig
            ? window.bookConfig.getCurrentBook()
            : null;

         if (bookConfig) {
            // Обновление метаданных
            document.title = `${bookConfig.title || "Название книги"
               } - Цифровая Библиотека`;
            document.getElementById("book-title").textContent =
               bookConfig.title || "Название книги";
            document.getElementById("book-author").textContent =
               bookConfig.author || "Автор неизвестен";
            document.getElementById("book-description").textContent =
               bookConfig.description || "Описание отсутствует";

            const posterImg = document.getElementById("book-poster");
            posterImg.src = bookConfig.poster || "/img/poster.jpg";
            posterImg.alt = `${bookConfig.title || "Название книги"
               } - обложка книги`;

            // Атрибуты
            document.body.setAttribute(
               "data-audio-folder",
               bookConfig.audioFolder || ""
            );
            document.body.setAttribute(
               "data-audio-count",
               bookConfig.audioCount || 0
            );
            document.body.setAttribute(
               "data-book-file",
               bookConfig.bookFile || ""
            );
            document.body.setAttribute(
               "data-book-type",
               bookConfig.bookFormat || ""
            );
            document.body.setAttribute(
               "data-poster-image",
               bookConfig.poster || "/img/poster.jpg"
            );

            // Показ аудио или текстовой версии
            const audioSection = document.getElementById("audio-section");
            const textVersionSection = document.getElementById(
               "text-version-section"
            );

            if (bookConfig.audioCount && bookConfig.audioCount > 0) {
               audioSection.style.display = "block";
               document.getElementById(
                  "audio-title"
               ).textContent = `Аудиокнига: ${bookConfig.title}`;
            } else {
               textVersionSection.style.display = "block";
               document
                  .getElementById("start-text-reading")
                  .addEventListener("click", () => {
                     document.getElementById("start-reading").click();
                  });
            }

            // Прогресс чтения
            const progress =
               window.bookReader &&
                  typeof window.bookReader.loadReadingProgress === "function"
                  ? window.bookReader.loadReadingProgress()
                  : { progress: 0 };

            const continueBtn = document.getElementById("continue-reading");
            if (progress.progress > 5) {
               continueBtn.style.display = "inline-flex";
               continueBtn.textContent = `Продолжить с ${Math.round(
                  progress.progress
               )}%`;
            }

            // Инициализация кнопки скачивания
            initializeDownloadButton(bookConfig);
         } else {
            console.error("Book configuration not found");
         }

         // Инициализация настроек
         setTimeout(() => {
            if (window.readingSettings) {
               console.log(
                  "ReadingSettings initialized:",
                  window.readingSettings.currentSettings.readingMode
               );
            }
         }, 1000);

         // Обновление имени текущей темы (если реализовано в theme.js)
         const updateThemeNameDisplay = () => {
            const activeTheme = document.querySelector(".theme-preset.active");
            if (activeTheme) {
               const themeName =
                  activeTheme.querySelector(".theme-name").textContent;
               document.getElementById("current-theme-name").textContent =
                  themeName;
            }
         };

         // Вызов при старте
         updateThemeNameDisplay();

         // Можно вызывать после смены темы (если есть кастомный event)
         document.querySelectorAll(".theme-preset").forEach((preset) => {
            preset.addEventListener("click", () => {
               document
                  .querySelectorAll(".theme-preset")
                  .forEach((p) => p.classList.remove("active"));
               preset.classList.add("active");
               updateThemeNameDisplay();
            });
         });
      });

      function initializeDownloadButton(bookConfig) {
         const downloadBtn = document.getElementById("download-book");
         if (!downloadBtn || !bookConfig || !bookConfig.id) {
            if (downloadBtn) downloadBtn.style.display = "none";
            return;
         }

         const bookId = bookConfig.id;
         const format = bookConfig.bookFormat || "fb2";
         const bookFilePath = `books-pack/${bookId}/book/${bookId}.${format}`;

         downloadBtn.href = bookFilePath;
         downloadBtn.setAttribute("download", `${bookId}.${format}`);
         console.log("Download configured:", bookFilePath);
      }

      // После инициализации DOM
      document.querySelectorAll(".theme-preset").forEach((preset) => {
         preset.addEventListener("click", function () {
            // Убираем класс active
            document.querySelectorAll(".theme-preset").forEach((el) => {
               el.classList.remove("active");
            });

            // Устанавливаем текущий
            this.classList.add("active");
            const statusEl = this.querySelector(".theme-status");
            statusEl.style.display = "inline";

            // Здесь можно вызвать смену темы, например:
            // applyTheme(this.dataset.theme); — если у тебя есть такая функция
         });
      });
   </script>

   <!-- Стили (временно в head/body) -->
   <style>
      .text-version-section {
         background: linear-gradient(135deg,
               var(--background-secondary) 0%,
               var(--background-primary) 100%);
         padding: 3rem 0;
         border-bottom: 1px solid var(--border-color);
      }

      .text-version-content {
         display: flex;
         align-items: center;
         gap: 2rem;
         max-width: 800px;
         margin: 0 auto;
         padding: 2rem;
         background: var(--background-primary);
         border-radius: var(--radius-xl);
         box-shadow: var(--shadow-lg);
         border: 1px solid var(--border-color);
      }

      .text-version-icon {
         font-size: 3rem;
         color: var(--primary-color);
         flex-shrink: 0;
      }

      .text-version-info h3 {
         color: var(--text-primary);
         margin-bottom: 1rem;
         font-size: 1.5rem;
      }

      .text-version-info p {
         color: var(--text-secondary);
         margin-bottom: 0.5rem;
         line-height: 1.6;
      }

      .text-version-actions {
         flex-shrink: 0;
      }

      @media (max-width: 768px) {
         .text-version-content {
            flex-direction: column;
            text-align: center;
            padding: 1.5rem;
         }

         .text-version-icon {
            font-size: 2.5rem;
         }
      }

      @media (max-width: 480px) {
         .text-version-section {
            padding: 2rem 0;
         }

         .text-version-content {
            padding: 1rem;
         }

         .text-version-icon {
            font-size: 2rem;
         }
      }
   </style>
</body>

</html>