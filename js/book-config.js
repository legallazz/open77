class BookConfig {
  constructor() {
    this.books = {
      neurofitness: {
        id: "neurofitness",
        title: "–ù–µ–π—Ä–æ—Ñ–∏—Ç–Ω–µ—Å",
        author: "–†–∞—Ö—É–ª –î–∂–∞–Ω–¥–∏–∞–ª",
        description:
          "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã –º–æ–∑–≥–∞ —á–µ—Ä–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ.",
        ageRating: "18+",
        readingTime: "~4 —á–∞—Å–∞",
        folder: "books-pack/neurofitness/",
        poster: "books-pack/neurofitness/images/poster.jpg",
        bookFile: "books-pack/neurofitness/book/neurofitness.fb2",
        bookFormat: "fb2",
        audioFolder: "books-pack/neurofitness/audio/",
        audioCount: 17,
        audioFiles: [],
        audioFileNames: [
          "01. –í–≤–µ–¥–µ–Ω–∏–µ",
          "02. –û—Å–Ω–æ–≤—ã –Ω–µ–π—Ä–æ—Ñ–∏—Ç–Ω–µ—Å–∞",
          "03. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –º–æ–∑–≥–∞",
          "04. –ü–∏—Ç–∞–Ω–∏–µ –¥–ª—è —É–º–∞",
          "05. –°–æ–Ω –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ",
          "06. –°—Ç—Ä–µ—Å—Å-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç",
          "07. –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏",
          "08. –§–∏–∑–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
          "09. –ú–µ–¥–∏—Ç–∞—Ü–∏—è",
          "10. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏",
          "11. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã",
          "12. –î–µ–Ω—å –∏–∑ –∂–∏–∑–Ω–∏",
          "13. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã",
          "14. –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã",
          "15. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ",
          "16. –ë–æ–Ω—É—Å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã",
          "17. –†–µ—Å—É—Ä—Å—ã",
        ],
        features: ["–ß—Ç–µ–Ω–∏–µ", "–ê—É–¥–∏–æ"],
        status: "available",
      },
      ezhevichnaya_zima: {
        id: "ezhevichnaya_zima",
        title: "–ï–∂–µ–≤–∏—á–Ω–∞—è –∑–∏–º–∞",
        author: "–°–∞—Ä–∞ –î–∂–∏–æ",
        description:
          "–ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–π —Ä–æ–º–∞–Ω –≤ –∂–∞–Ω—Ä–µ –∂–µ–Ω—Å–∫–æ–π –ø—Ä–æ–∑—ã —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Ç–∞–π–Ω—ã –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –¥—Ä–∞–º—ã.",
        ageRating: "16+",
        readingTime: "~10 —á–∞—Å–æ–≤",
        folder: "books-pack/ezhevichnaya_zima/",
        poster: "books-pack/ezhevichnaya_zima/images/poster.jpg",
        bookFile: "books-pack/ezhevichnaya_zima/book/ezhevichnaya_zima.fb2",
        bookFormat: "fb2",
        audioFolder: "books-pack/ezhevichnaya_zima/audio/",
        audioCount: 20,
        audioFiles: [],
        audioFileNames: [
          "01. –ü—Ä–æ–ª–æ–≥",
          "02. –ü—Ä–∏–±—ã—Ç–∏–µ",
          "03. –ü–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞",
          "04. –¢–∞–π–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è",
          "05. –°—Ç–∞—Ä—ã–µ –ø–∏—Å—å–º–∞",
          "06. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è",
          "07. –°–≤—è–∑—å –≤—Ä–µ–º–µ–Ω",
          "08. –û—Ç–∫—Ä—ã—Ç–∏–µ",
          "09. –°–µ—Ä–¥–µ—á–Ω—ã–µ –¥–µ–ª–∞",
          "10. –ü–æ–≤–æ—Ä–æ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç",
          "11. –¢–µ–º–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã",
          "12. –ö–æ–Ω—Ñ—Ä–æ–Ω—Ç–∞—Ü–∏—è",
          "13. –ü—Ä–æ—à–ª–æ–µ –Ω–∞—Å—Ç–∏–≥–∞–µ—Ç",
          "14. –û–±—ä—è—Å–Ω–µ–Ω–∏—è",
          "15. –ü—Ä–∏–º–∏—Ä–µ–Ω–∏–µ",
          "16. –ù–æ–≤—ã–µ –Ω–∞—á–∞–ª–∞",
          "17. –≠–ø–∏–ª–æ–≥",
          "18. –ë–æ–Ω—É—Å–Ω–∞—è –≥–ª–∞–≤–∞ 1",
          "19. –ë–æ–Ω—É—Å–Ω–∞—è –≥–ª–∞–≤–∞ 2",
          "20. –ü–æ—Å–ª–µ—Å–ª–æ–≤–∏–µ",
        ],
        features: ["–ß—Ç–µ–Ω–∏–µ", "–ê—É–¥–∏–æ"],
        status: "available",
      },
      atomnye_privychki: {
        id: "atomnye_privychki",
        title: "–ê—Ç–æ–º–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏",
        author: "–î–∂–µ–π–º—Å –ö–ª–∏—Ä", // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ö–ª–∏—Ä –î–∂–µ–π–º—Å ‚Üí –î–∂–µ–π–º—Å –ö–ª–∏—Ä
        description:
          "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ–ª–µ–∑–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –∏–∑–±–∞–≤–ª–µ–Ω–∏—é –æ—Ç –≤—Ä–µ–¥–Ω—ã—Ö —á–µ—Ä–µ–∑ –º–∞–ª–µ–Ω—å–∫–∏–µ, –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.",
        ageRating: "16+",
        readingTime: "~8 —á–∞—Å–æ–≤",
        folder: "books-pack/atomnye_privychki/",
        poster: "books-pack/atomnye_privychki/images/poster.jpg",
        bookFile: "books-pack/atomnye_privychki/book/atomnye_privychki.fb2",
        bookFormat: "fb2",
        audioFolder: "books-pack/atomnye_privychki/audio/",
        audioCount: 24,
        audioFiles: [
          "00.mp3",
          "01.mp3",
          "02.mp3",
          "03.mp3",
          "04.mp3",
          "05.mp3",
          "06.mp3",
          "07.mp3",
          "08.mp3",
          "09.mp3",
          "10.mp3",
          "11.mp3",
          "12.mp3",
          "13.mp3",
          "14.mp3",
          "15.mp3",
          "16.mp3",
          "17.mp3",
          "18.mp3",
          "19.mp3",
          "20.mp3",
          "21.mp3",
          "22.mp3",
          "23.mp3",
          "24.mp3",
        ],
        audioFileNames: [
          "–í–≤–µ–¥–µ–Ω–∏–µ",
          "–ì–ª–∞–≤–∞ 1",
          "–ì–ª–∞–≤–∞ 2",
          "–ì–ª–∞–≤–∞ 3",
          "–ì–ª–∞–≤–∞ 4",
          "–ì–ª–∞–≤–∞ 5",
          "–ì–ª–∞–≤–∞ 6",
          "–ì–ª–∞–≤–∞ 7",
          "–ì–ª–∞–≤–∞ 8",
          "–ì–ª–∞–≤–∞ 9",
          "–ì–ª–∞–≤–∞ 10",
          "–ì–ª–∞–≤–∞ 11",
          "–ì–ª–∞–≤–∞ 12",
          "–ì–ª–∞–≤–∞ 13",
          "–ì–ª–∞–≤–∞ 14",
          "–ì–ª–∞–≤–∞ 15",
          "–ì–ª–∞–≤–∞ 16",
          "–ì–ª–∞–≤–∞ 17",
          "–ì–ª–∞–≤–∞ 18",
          "–ì–ª–∞–≤–∞ 19",
          "–ì–ª–∞–≤–∞ 20",
          "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ",
          "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
          "–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏",
        ],
        features: ["–ß—Ç–µ–Ω–∏–µ", "–ê—É–¥–∏–æ"],
        status: "available",
      },
      bozhestvennaya_komediya: {
        id: "bozhestvennaya_komediya",
        title: "–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–µ–¥–∏—è",
        author: "–î–∞–Ω—Ç–µ –ê–ª–∏–≥—å–µ—Ä–∏",
        description:
          "–ü–æ—ç–º–∞ –∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–≥–æ –ø–æ—ç—Ç–∞ –î–∞–Ω—Ç–µ –ê–ª–∏–≥—å–µ—Ä–∏, –Ω–∞–ø–∏—Å–∞–Ω–Ω–∞—è –≤ –Ω–∞—á–∞–ª–µ XIV –≤–µ–∫–∞.",
        ageRating: "16+",
        readingTime: "~21 —á–∞—Å",
        folder: "books-pack/bozhestvennaya_komediya/",
        poster: "books-pack/bozhestvennaya_komediya/images/poster.jpg",
        bookFile:
          "books-pack/bozhestvennaya_komediya/book/bozhestvennaya_komediya.fb2",
        bookFormat: "fb2",
        audioFolder: "books-pack/bozhestvennaya_komediya/audio/",
        audioCount: 100,
        audioFiles: Array.from({ length: 100 }, (_, i) => {
          if (i < 34) {
            return `1_${String(i + 1).padStart(2, "0")}.mp3`;
          } else if (i < 67) {
            const num = i - 34 + 1;
            return `2_${String(num).padStart(2, "0")}.mp3`;
          } else {
            const num = i - 67 + 1;
            return `3_${String(num).padStart(2, "0")}.mp3`;
          }
        }),
        audioFileNames: Array.from({ length: 100 }, (_, i) => {
          if (i < 34) {
            return `–ê–¥, –ü–µ—Å–Ω—å ${i + 1}`;
          } else if (i < 67) {
            const num = i - 34 + 1;
            return `–ß–∏—Å—Ç–∏–ª–∏—â–µ, –ü–µ—Å–Ω—å ${num}`;
          } else {
            const num = i - 67 + 1;
            return `–†–∞–π, –ü–µ—Å–Ω—å ${num}`;
          }
        }),
        features: ["–ß—Ç–µ–Ω–∏–µ", "–ê—É–¥–∏–æ"],
        status: "available",
      },
    };

    this.currentBookId = null;
  }

  getBook(bookId) {
    return this.books[bookId] || null;
  }

  getAllBooks() {
    return Object.values(this.books);
  }

  setCurrentBookFromUrl() {
    const path = window.location.pathname;
    const fileName = path.split("/").pop();
    const bookId = fileName.replace(".html", "");

    if (this.books[bookId]) {
      this.currentBookId = bookId;
      return bookId;
    }
    return null;
  }

  getCurrentBook() {
    if (this.currentBookId) {
      return this.books[this.currentBookId];
    }
    const bookId = this.setCurrentBookFromUrl();
    return bookId ? this.books[bookId] : null;
  }

  addBook(config) {
    if (!config.id) {
      console.error("Book ID is required");
      return false;
    }

    const audioFiles =
      config.audioFiles ||
      Array.from(
        { length: config.audioCount || 0 },
        (_, i) => `${String(i + 1).padStart(2, "0")}.mp3`
      );

    const audioFileNames =
      config.audioFileNames ||
      Array.from(
        { length: config.audioCount || 0 },
        (_, i) => `–ì–ª–∞–≤–∞ ${i + 1}`
      );

    this.books[config.id] = {
      id: config.id,
      title: config.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
      author: config.author || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä",
      description: config.description || "",
      ageRating: config.ageRating || "0+",
      readingTime: config.readingTime || "~1 —á–∞—Å",
      folder: config.folder || `books-pack/${config.id}/`,
      poster: config.poster || `books-pack/${config.id}/images/poster.jpg`,
      bookFile:
        config.bookFile || `books-pack/${config.id}/book/${config.id}.fb2`,
      bookFormat: config.bookFormat || "fb2",
      audioFolder: config.audioFolder || `books-pack/${config.id}/audio/`,
      audioCount: config.audioCount || 0,
      audioFiles: audioFiles,
      audioFileNames: audioFileNames,
      features:
        config.features ||
        ["–ß—Ç–µ–Ω–∏–µ"].concat(config.audioCount > 0 ? ["–ê—É–¥–∏–æ"] : []),
      status: config.status || "available",
    };

    return true;
  }

  removeBook(bookId) {
    if (this.books[bookId]) {
      delete this.books[bookId];
      return true;
    }
    return false;
  }

  updateBook(bookId, updates) {
    if (this.books[bookId]) {
      this.books[bookId] = { ...this.books[bookId], ...updates };
      return true;
    }
    return false;
  }

  exportConfig() {
    return JSON.stringify(this.books, null, 2);
  }

  importConfig(configJson) {
    try {
      const config = JSON.parse(configJson);
      this.books = { ...this.books, ...config };
      return true;
    } catch (error) {
      console.error("Error importing config:", error);
      return false;
    }
  }

  getBooksByStatus(status) {
    return Object.values(this.books).filter((book) => book.status === status);
  }

  getAvailableBooks() {
    return this.getBooksByStatus("available");
  }

  getComingSoonBooks() {
    return this.getBooksByStatus("coming-soon");
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
window.bookConfig = new BookConfig();
class BookDOMHelper {
  static updateHomePageProgress(bookId, progressPercent) {
    const bookCard = document.querySelector(`[data-book="${bookId}"]`);
    if (bookCard) {
      const progressFill = bookCard.querySelector(".progress-fill");
      const progressText = bookCard.querySelector(
        ".progress-info span:first-child"
      );
      const actionButton = bookCard.querySelector("button");

      if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
      }

      if (progressText) {
        progressText.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${Math.round(progressPercent)}%`;
      }

      if (actionButton && progressPercent > 5) {
        actionButton.innerHTML =
          '<i class="fas fa-book-open"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ';
      }
    }
  }

  static updateBookPage(bookConfig) {
    if (!bookConfig) {
      console.error("No book configuration provided");
      return;
    }

    const progress = window.bookReader
      ? window.bookReader.loadReadingProgress()
      : { progress: 0 };

    const progressFill = document.getElementById("progress-fill");
    const progressText = document.getElementById("progress-text");
    const startBtn = document.getElementById("start-reading");

    if (progressFill) {
      progressFill.style.width = `${progress.progress || 0}%`;
    }

    if (progressText) {
      progressText.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${Math.round(
        progress.progress || 0
      )}%`;
    }

    if (startBtn && progress.progress > 5) {
      startBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ";
      startBtn.innerHTML = '<i class="fas fa-book-open"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ';
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.title = `${bookConfig.title} - –¶–∏—Ñ—Ä–æ–≤–∞—è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞`;

    // –û–±–Ω–æ–≤–ª—è–µ–º meta description
    let metaDescription = document.querySelector('meta[name="description"]');
    if (!metaDescription) {
      metaDescription = document.createElement("meta");
      metaDescription.name = "description";
      document.head.appendChild(metaDescription);
    }
    // üîß –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    metaDescription.content = `–ß–∏—Ç–∞–π—Ç–µ –∫–Ω–∏–≥—É ${bookConfig.title} –æ—Ç ${bookConfig.author} –æ–Ω–ª–∞–π–Ω —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ü–≤–µ—Ç–æ–≤ –∏ —Ç–µ–º—ã –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è.`;

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±–ª–æ–∂–∫—É
    const posterImg = document.getElementById("book-poster");
    if (posterImg) {
      posterImg.src = bookConfig.poster;
      posterImg.alt = `${bookConfig.title} - –æ–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏`;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const titleElements = document.querySelectorAll(
      ".book-title-large, .book-nav-title, #book-title-menu"
    );
    titleElements.forEach((el) => {
      if (el) {
        el.textContent = bookConfig.title;
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–∞
    const authorElements = document.querySelectorAll(".book-author-large");
    authorElements.forEach((el) => {
      if (el) {
        el.textContent = bookConfig.author;
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    const descriptionElements = document.querySelectorAll(
      ".book-description-large"
    );
    descriptionElements.forEach((el) => {
      if (el) {
        el.textContent = bookConfig.description;
      }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞—É–¥–∏–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if (bookConfig.audioCount > 0) {
      const audioInfo = document.querySelector(".audio-info h3");
      if (audioInfo) {
        audioInfo.textContent = `–ê—É–¥–∏–æ–∫–Ω–∏–≥–∞: ${bookConfig.title}`;
      }
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã –∏ –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    if (bookConfig.status === "available") {
      document.body.setAttribute("data-audio-folder", bookConfig.audioFolder);
      document.body.setAttribute(
        "data-audio-count",
        String(bookConfig.audioCount)
      );
      document.body.setAttribute("data-book-file", bookConfig.bookFile);
      document.body.setAttribute("data-book-type", bookConfig.bookFormat);
      document.body.setAttribute("data-poster-image", bookConfig.poster);

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      const downloadLink = document.getElementById("download-book");
      if (downloadLink) {
        downloadLink.href = bookConfig.bookFile;
        const fileName = `${bookConfig.id}.${bookConfig.bookFormat}`;
        downloadLink.setAttribute("download", fileName);
      }
    } else {
      // –ï—Å–ª–∏ –∫–Ω–∏–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
      const downloadLink = document.getElementById("download-book");
      if (downloadLink) {
        downloadLink.href = "#";
        downloadLink.removeAttribute("download");
        downloadLink.onclick = (e) => {
          e.preventDefault();
          window.showComingSoon(bookConfig?.title || "–ö–Ω–∏–≥–∞");
        };
      }
    }
  }

  static generateBookCard(bookConfig) {
    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —á—Ç–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –∫–Ω–∏–≥–∏
    const progressData = localStorage.getItem(
      `reading-progress-${bookConfig.id}`
    );
    let progressPercent = 0;
    try {
      if (progressData) {
        const parsed = JSON.parse(progressData);
        progressPercent = parsed.progress || 0;
      }
    } catch (e) {
      console.warn("Could not parse progress data:", e);
    }

    return `
  <div class="compact-book-card" data-book="${bookConfig.id}">
    <div class="compact-book-cover">
      ${
        bookConfig.poster
          ? `<img src="${bookConfig.poster}" alt="${bookConfig.title}" loading="lazy" />`
          : ""
      }
      <div class="compact-book-badges">
        <span class="compact-book-status">${
          bookConfig.ageRating || "16+"
        }</span>
      </div>
    </div>
    
    <div class="compact-book-info">
      <h3 class="book-title">${bookConfig.title}</h3>
      <p class="book-author">${bookConfig.author}</p>
      <p class="book-description">${bookConfig.description}</p>
      
      <div class="book-metadata">
        <span class="reading-time">${bookConfig.readingTime || "~3 —á–∞—Å–∞"}</span>
      </div>
      
      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      <div class="book-progress-section" style="margin: 10px 0;">
        <div class="progress-bar" style="height: 4px; background: var(--surface-secondary); border-radius: 2px;">
          <div class="progress-fill" style="width: ${progressPercent}%; height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.3s ease;"></div>
        </div>
        <div class="progress-info" style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: var(--text-secondary);">
          <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${Math.round(progressPercent)}%</span>
          ${progressPercent > 5 ? `<span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ</span>` : ""}
        </div>
      </div>
      
      <div class="compact-book-features">
        ${bookConfig.features
          .map(
            (feature) => `
          <span class="compact-feature">
            <i class="fas ${
              feature === "–ê—É–¥–∏–æ" ? "fa-headphones" : "fa-book"
            }"></i> ${feature}
          </span>
        `
          )
          .join("")}
      </div>
      
      <button class="btn-primary mgb" onclick="openBook('${bookConfig.id}')" 
              data-testid="button-read-${bookConfig.id}">
        <i class="fas fa-book-open"></i> 
        ${
          bookConfig.status === "available"
            ? progressPercent > 5
              ? "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ"
              : "–ß–∏—Ç–∞—Ç—å"
            : "–°–∫–æ—Ä–æ"
        }
      </button>
    </div>
  </div>
  `;
  }

  static renderBooksGrid(containerId, books) {
    const container = document.getElementById(containerId);
    if (!container) {
      console.error(`Container with id "${containerId}" not found`);
      return;
    }

    if (books.length === 0) {
      container.innerHTML = '<div class="no-books">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
      return;
    }

    container.innerHTML = books
      .map((book) => this.generateBookCard(book))
      .join("");
  }

  static loadAndDisplayProgress(bookId) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ localStorage
    const saved = localStorage.getItem(`reading-progress-${bookId}`);
    if (saved) {
      try {
        const progressData = JSON.parse(saved);
        const progressPercent = progressData.progress || 0;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ ID!)
        const progressElements = [
          "reading-progress-fill",
          "reading-modal-progress-fill",
          "progress-fill", // –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –µ—Å—Ç—å –≥–¥–µ-—Ç–æ
        ];

        const textElements = [
          "reading-progress-text",
          "reading-modal-progress-text",
          "progress-text", // –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –µ—Å—Ç—å –≥–¥–µ-—Ç–æ
        ];

        progressElements.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.style.width = `${progressPercent}%`;
          }
        });

        textElements.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = `${Math.round(progressPercent)}%`;
          }
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
        const startBtn = document.getElementById("start-reading");
        const continueBtn = document.getElementById("continue-reading");

        if (progressPercent > 5) {
          if (startBtn) {
            startBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ";
            startBtn.innerHTML =
              '<i class="fas fa-book-open"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ';
          }
          if (continueBtn) {
            continueBtn.style.display = "inline-flex";
            continueBtn.style.visibility = "visible";
            try {
              continueBtn.textContent = `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å ${Math.round(
                progressPercent
              )}%`;
            } catch (e) {
              console.warn(
                "Could not set continueBtn textContent in loadAndDisplayProgress:",
                e
              );
            }
          }

          // –°–¥–µ–ª–∞—Ç—å –≤–∏–¥–∏–º–æ–π –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
          const continueAudioBtn =
            document.getElementById("continue-listening");
          if (continueAudioBtn) {
            continueAudioBtn.style.display = "inline-flex";
            continueAudioBtn.style.visibility = "visible";
          }
        } else {
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –º–∞–ª–µ–Ω—å–∫–∏–π
          if (continueBtn) {
            continueBtn.style.display = "none";
          }
          const continueAudioBtn =
            document.getElementById("continue-listening");
          if (continueAudioBtn) {
            continueAudioBtn.style.display = "none";
          }
        }

        console.log(`Progress loaded for ${bookId}: ${progressPercent}%`);
      } catch (e) {
        console.error("Error loading progress:", e);
      }
    }
  }

  static updateHomePage() {
    const availableBooks = window.bookConfig.getAvailableBooks();
    this.renderBooksGrid("books-grid", availableBooks);

    const comingSoonBooks = window.bookConfig.getComingSoonBooks();
    if (comingSoonBooks.length > 0) {
      this.renderBooksGrid("coming-soon-grid", comingSoonBooks);
    }
  }

  static updateHomePageProgress(bookId, progressPercent) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
    const bookCard = document.querySelector(`[data-book="${bookId}"]`);
    if (bookCard) {
      const progressFill = bookCard.querySelector(".progress-fill");
      const progressText = bookCard.querySelector(
        ".progress-info span:first-child"
      );
      const actionButton = bookCard.querySelector("button");

      if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
      }

      if (progressText) {
        progressText.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${Math.round(progressPercent)}%`;
      }

      if (actionButton && progressPercent > 5) {
        actionButton.innerHTML =
          '<i class="fas fa-book-open"></i> –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á—Ç–µ–Ω–∏–µ';
      }
    }
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener("DOMContentLoaded", function () {
  if (document.querySelector(".book-header")) {
    const bookConfig = window.bookConfig.getCurrentBook();
    if (bookConfig) {
      BookDOMHelper.updateBookPage(bookConfig);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
      BookDOMHelper.loadAndDisplayProgress(bookConfig.id);
    } else {
      console.error("Book configuration not found for current page");
    }
  }

  if (document.getElementById("books-grid")) {
    BookDOMHelper.updateHomePage();
  }
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
window.openBook = function (bookId) {
  const bookConfig = window.bookConfig.getBook(bookId);
  if (bookConfig && bookConfig.status === "available") {
    window.location.href = `${bookId}.html`;
  } else {
    window.showComingSoon(bookConfig?.title || bookId);
  }
};

window.showComingSoon = function (bookTitle) {
  alert(`${bookTitle} –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!`);
};
